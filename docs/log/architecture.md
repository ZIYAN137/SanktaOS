# 日志系统架构

## 分层与职责

Log 子系统分为两层：

1) **OS 层包装（`os/src/log/mod.rs`）**
- 负责在启动早期注册日志上下文（CPU/任务/时间戳）与输出（控制台）。
- 提供面向内核其他模块使用的 `pr_*` 宏（宏内部调用 `crate::log` 重新导出的实现）。

2) **核心实现（`crates/klog/src/`）**
- 定义日志级别（`LogLevel`）与条目结构（`LogEntry`）。
- 维护全局日志环形缓冲区（多生产者并发写入，单消费者读取）。
- 实现“双路输出”：一条写入缓冲区用于后续读取，一条按控制台级别即时输出。

## 数据路径

- **写入路径**：`pr_*` 宏 → 级别判定 → 写入环形缓冲区 →（满足控制台级别时）立即输出到控制台。
- **读取路径**：用户态通过 `syslog` 系统调用（`os/src/kernel/syscall/sys.rs`）读取/查询/清空日志缓冲区。

## 关键语义

- **双过滤器**：
  - 全局级别控制“哪些日志会进入缓冲区”；
  - 控制台级别控制“哪些日志会即时打印”。
- **缓冲区溢出**：环形缓冲区容量有限，写入压力过大时旧日志可能被覆盖；实现中会记录丢弃计数。
- **syslog action**：操作类型与参数语义由 `crates/uapi/src/log.rs` 的 `SyslogAction` 定义；内核侧实现位于 `os/src/kernel/syscall/sys.rs`。
